<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatterSun Ultra Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #00a884;
            --admin-red: #ff4b4b;
            --bg-dark: #0b141a;
            --panel: #202c33;
            --input-bg: #2a3942;
            --text: #e9edef;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* –®–∞–ø–∫–∞ —Å–∞–π—Ç—É */
        header {
            background: var(--panel);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .status-dot { height: 10px; width: 10px; background: #00ff00; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç—É */
        #chat-screen { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background: linear-gradient(rgba(11,20,26,0.95), rgba(11,20,26,0.95)), url('https://www.transparenttextures.com/patterns/cubes.png');
            display: flex; 
            flex-direction: column; 
            gap: 12px;
        }

        /* –°—Ç–∏–ª—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        .msg { 
            padding: 10px 15px; 
            border-radius: 12px; 
            max-width: 75%; 
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .msg-in { background: var(--panel); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-out { background: #005c4b; align-self: flex-end; border-bottom-right-radius: 2px; }

        .msg b { display: block; font-size: 0.85rem; color: var(--primary); margin-bottom: 4px; }
        .msg .time { font-size: 0.7rem; color: #8696a0; margin-top: 4px; text-align: right; display: block; }
        
        /* –†–µ–∞–∫—Ü—ñ—ó —Ç–∞ –∫–Ω–æ–ø–∫–∏ */
        .reactions { margin-top: 8px; display: flex; gap: 10px; align-items: center; }
        .react-badge { font-size: 1.1rem; }
        .btn-tool { background: none; border: none; color: #8696a0; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn-tool:hover { color: white; transform: scale(1.2); }

        /* –ü–æ–ª–µ –≤–≤–æ–¥—É */
        .input-area { 
            background: var(--panel); 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        input { 
            flex: 1; 
            padding: 12px 20px; 
            border-radius: 25px; 
            border: none; 
            background: var(--input-bg); 
            color: white; 
            outline: none;
            font-size: 1rem;
        }

        .send-btn { background: var(--primary); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É */
        #login-screen { 
            position: fixed; inset: 0; 
            background: var(--bg-dark); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            z-index: 2000; 
        }

        .login-card { background: var(--panel); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 300px; }
        .login-card h2 { color: var(--primary); margin-bottom: 25px; }
    </style>
</head>
<body>

<header>
    <div><span class="status-dot"></span> ChatterSun <b>Pro</b></div>
    <div id="user-info" style="font-size: 0.8rem; color: #8696a0;"></div>
</header>

<div id="login-screen">
    <div class="login-card">
        <h2>–í—Ö—ñ–¥ —É —á–∞—Ç</h2>
        <input type="text" id="username" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º" style="width: 80%; margin-bottom: 20px; text-align: center;">
        <button onclick="login()" style="width: 100%; padding: 12px; border-radius: 25px; background: var(--primary); border: none; color: white; font-weight: bold; cursor: pointer;">–£–í–Ü–ô–¢–ò</button>
        <p id="auth-error" style="color: red; font-size: 0.8rem; margin-top: 10px;"></p>
    </div>
</div>

<div id="chat-screen"></div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." onkeypress="if(event.key==='Enter') sendMsg()">
    <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove, update, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // –í–∞—à–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
    const firebaseConfig = {
  apiKey: "AIzaSyClFOMxAzvXcWFM9wlz6ZmtfvgOW14Vs5w",
  authDomain: "chattersun-174b5.firebaseapp.com",
  databaseURL: "https://chattersun-174b5-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "chattersun-174b5",
  storageBucket: "chattersun-174b5.firebasestorage.app",
  messagingSenderId: "786057798847",
  appId: "1:786057798847:web:32a34d9abc22087289d20a",
  measurementId: "G-DYZQE6VHBB"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const ADMIN_UID = "IgYoiWc48LYM9bfja8ujxhRDivm2"; // –í–∞—à UID

    window.login = () => {
        const name = document.getElementById('username').value.trim();
        if (name) {
            localStorage.setItem('chatName', name);
            signInAnonymously(auth).catch(e => {
                document.getElementById('auth-error').innerText = "–ü–æ–º–∏–ª–∫–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ API –∫–ª—é—á.";
                console.error(e);
            });
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('user-info').innerText = "–í –º–µ—Ä–µ–∂—ñ —è–∫: " + localStorage.getItem('chatName');
        }
    });

    window.sendMsg = () => {
        const text = document.getElementById('msgInput').value.trim();
        if (text && auth.currentUser) {
            push(ref(db, 'messages'), {
                uid: auth.currentUser.uid,
                name: localStorage.getItem('chatName'),
                text: text,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                reactions: ""
            });
            document.getElementById('msgInput').value = '';
        }
    };

    onChildAdded(ref(db, 'messages'), (snapshot) => {
        renderMessage(snapshot);
    });

    onChildChanged(ref(db, 'messages'), (snapshot) => {
        const data = snapshot.val();
        const textEl = document.querySelector(`#msg-${snapshot.key} .text-content`);
        const reactEl = document.querySelector(`#msg-${snapshot.key} .react-badge`);
        if (textEl) textEl.innerText = data.text;
        if (reactEl) reactEl.innerText = data.reactions || '';
    });

    onChildRemoved(ref(db, 'messages'), (snapshot) => {
        document.getElementById(`msg-${snapshot.key}`)?.remove();
    });

    function renderMessage(snapshot) {
        const data = snapshot.val();
        const key = snapshot.key;
        const isMe = auth.currentUser?.uid === data.uid;
        const isAdmin = auth.currentUser?.uid === ADMIN_UID;

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'msg-out' : 'msg-in'}`;
        div.id = `msg-${key}`;
        
        div.innerHTML = `
            <b>${data.name}</b>
            <span class="text-content">${linkify(data.text)}</span>
            <div class="reactions">
                <span class="react-badge">${data.reactions || ''}</span>
                <button class="btn-tool" onclick="addReact('${key}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="btn-tool" onclick="addReact('${key}', 'üî•')">üî•</button>
                ${isMe || isAdmin ? `<button class="btn-tool" onclick="editMsg('${key}')"><i class="fas fa-edit"></i></button>` : ''}
                ${isAdmin ? `<button class="btn-tool" onclick="delMsg('${key}')" style="color:var(--admin-red)"><i class="fas fa-trash"></i></button>` : ''}
            </div>
            <span class="time">${data.time}</span>
        `;
        document.getElementById('chat-screen').appendChild(div);
        document.getElementById('chat-screen').scrollTop = document.getElementById('chat-screen').scrollHeight;
    }

    function linkify(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:#25D366">${url}</a>`);
    }

    window.addReact = (key, emoji) => {
        const badge = document.querySelector(`#msg-${key} .react-badge`).innerText;
        update(ref(db, `messages/${key}`), { reactions: (badge + emoji).slice(-10) });
    };

    window.editMsg = (key) => {
        const oldText = document.querySelector(`#msg-${key} .text-content`).innerText;
        const n = prompt("–ó–º—ñ–Ω–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:", oldText);
        if (n && n !== oldText) update(ref(db, `messages/${key}`), { text: n });
    };

    window.delMsg = (key) => {
        if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É –≤—Å—ñ—Ö?")) remove(ref(db, `messages/${key}`));
    };
</script>

</body>
</html>
